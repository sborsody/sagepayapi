<?php

// $Id$

/**
 * Hopefully, this will be a module that allows anything to integrate with Sagepay Server
 *
 * Sage Pay Form Steps
 * Step 1: Customer orders from your site
 * Step 2: Build a confirmation page with the four hidden fields
 * Step 8: Sage Pay redirects customer back to site, check status fields
 *
 * @todo
 *   deposit fee (submitted by user through hidden link provided by salesperson after working with applicant): 500GBP, US$750, €625, AUD$1000
 *   program balance payoff (submitted by either user via hidden link provided by salesperson after working with applicant): variable
 */

// Sagepay Form URLS
define(SAGEPAYAPI_FORM_SIMULATOR_URL, 'https://test.sagepay.com/simulator/vspformgateway.asp');
define(SAGEPAYAPI_FORM_TEST_URL, 'https://test.sagepay.com/gateway/service/vspform-register.vsp');
define(SAGEPAYAPI_FORM_LIVE_URL, 'https://live.sagepay.com/gateway/service/vspform-register.vsp');

if (!empty(variable_get('sagepayapi_debug', ''))) {
  define(SAGEPAYAPI_DEBUG, TRUE);
}

/**
 * Implements hook_perm
 */
function sagepayapi_perm() {
  return array('administer sagepayapi');
}

/**
 * Implements hook_menu
 */
function sagepayapi_menu() {
  // Administrative settings page
  $items['admin/settings/sagepayapi'] = array(
    'title' => 'Sagepay API Settings',
    'description' => 'Helper functions for hooking anything Drupal to Sagepay',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sagepayapi_admin_settings'),
    'access arguments' => array('administer sagepayapi'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'sagepayapi.pages.inc',
  );

  // Order page
  $items['sagepayapi/order'] = array(
    'title' => 'Order',
    'description' => 'Builds a form for submitting to Sage Pay',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sagepayapi_form_order_form'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'sagepayapi.pages.inc',
  );
  // Order page with arguments
  $items['sagepayapi/order/%type'] = array(
    'title' => 'Order',
    'description' => 'Builds a form with arguments for submitting to Sage Pay',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sagepayapi_form_order_form', 2),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'sagepayapi.pages.inc',
  );
  
  // Form completion page
  $items['sagepayapi/thankyou'] = array(
    'title' => 'Complete',
    //'title callback' => 'sagepayapi_thankyou_title', // This should be dependent upon whether there is success or failure
    'description' => 'Displays success or failure of Sage Pay Form transaction',
    'page callback' => 'sagepayapi_form_transaction_status',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'sagepayapi.pages.inc',
  );

  return $items;
}

/** THEMING FUNCTIONS **/

/**
 * Implements hook_theme()
 */
function sagepayapi_theme() {
  return array(
    'sagepayapi_form_order_form' => array(
      'arguments' => array('form' => NULL)
    ),
    'sagepayapi_form_order_review' => array(
      'arguments' => array('elements' => NULL)
    ),
  );
}

/**
 * Theme the Sagepayapi Form order form
 */
function theme_sagepayapi_form_order_form($form) {
  $output = '';
  // Page one of the form
  if ($form['billing']) {
    $output .= '<h3>';
    $output .= t('Please enter your billing information.');
    $output .= '</h3>';
  }
  // Page two of the form
  if ($form['Crypt']) {
    $output .= '<h3>';
    $output .= t('Please review your billing details.');
    $output .= '</h3>';
    $output .= '<p>' . t('You will be taken to a secure server to enter your payment information on the next screen.  If you need to go back and edit your details, please hit the back button on your browser.') . '</p>';

  }
  $output .= drupal_render($form);
  return $output;
}

/**
 * Theme the review of the order and billing details
 */
function theme_sagepayapi_form_order_review(&$elements) {
  $output = '<div id="sagepay-order-review">';
  foreach ($elements as $element) {
    if (is_array($element) && $element['#parents'][0] == 'review') {
      $output .= '<strong>' . $element['#title'] . ':</strong> ' . $element['#value'] . '<br />';
    }
  }
  $output .= '</div>';
  return $output;
}

/**
 * Returns a dummy order array for testing purposes
 *
 * @return
 *   An array
 */
function sagepayapi_dummy_order() {
  return array(
    'Description' => t('Dummy Order'),
    'Amount' => '1',
    'BillingSurname' => 'Borsody',
    'BillingFirstnames' => 'Stacey',
    'CustomerEmail' => "stacey.borsody@yahoo.com",
    'BillingAddress1' => '123 Main St.',
    'BillingCity' => 'Pleasanton',
    'BillingPostcode' => '94566',
    'BillingState' => "CA",
    'BillingCountry' => 'US',
    'BillingPhone' => '1-925-640-2034',
    'DeliverySurname' => 'Borsody',
    'DeliveryFirstnames' => 'Stacey',
    'DeliveryAddress1' => '123 Main St.',
    'DeliveryCity' => 'Pleasanton',
    'DeliveryPostcode' => '94566',
    'DeliveryState' => "CA",
    'DeliveryCountry' => 'US',
  );
}

/**
 * Generate a Sage Pay Form crypt string
 *
 * @param $data
 *   Takes an associative array of order form information
 *
 * @return
 *   Returns encrypted and encoded string
 */
function sagepayapi_form_get_crypt_string($data) {
  $strencryptionpassword = variable_get('sagepayapi_encrypted_pass', '');
  if (!strencryptionpassword) {
    drupal_set_message(t('Sage Pay API: Double check the XOR encryption password on the sagepayapi settings page.'), 'error');
  }
  // http_build_query is not useful here because we don't need the strings urlencoded for Sage Pay Form.
  // $strPost = http_build_query($data, NULL, '&');
  // So instead we'll build the query string manually without urlencoding and encrypt and base64 encode it.
  $strPost = '';
  foreach ($data as $name => $value) {
    $strPost .= $name . '=' . $value . '&';
  }
  // Remove the last ampersand from the string because we're at the end of our query string.
  $strPost = substr($strPost, 0, -1);

  // If debugging is turned on, send unencrypted string to watchdog
  if (defined(SAGEPAYAPI_DEBUG)) {
    watchdog('sagepayapi','Unencoded transaction registration string !strpost', array('!strpost' => $strPost) , WATCHDOG_DEBUG);
  }
  // Now encrypt it with our XOR password and encode it
  $strCrypt = _sagepayapi_base64_encode(_sagepayapi_simpleXor($strPost, $strencryptionpassword));

  return $strCrypt;
}

/* INCLUDES from sample php kit */
/**
 * Generate a unique VendorTxCode
 */
function sagepayapi_get_vendortxcode() {
  $intRandNum = rand(1, 32000)*rand(0, 32000);
  $vendortxcode = variable_get('sagepayapi_vendor', 'XXX') . time() . $intRandNum;
  return $vendortxcode;
}

/**
 * NOTE: A function of convenience that extracts the value from the "name=value&name2=value2..." reply string 
 * Works even if one of the values is a URL containing the & or = signs.
 *
 * @param $thisString
 *
 * @return
 */
function _sagepayapi_get_tokens($thisString) {

  // List the possible tokens
  $Tokens = array(
    "Status",
    "StatusDetail",
    "VendorTxCode",
    "VPSTxId",
    "TxAuthNo",
    "Amount",
    "AVSCV2", 
    "AddressResult", 
    "PostCodeResult", 
    "CV2Result", 
    "GiftAid", 
    "3DSecureStatus", 
    "CAVV",
    "AddressStatus",
    "CardType",
    "Last4Digits",
    "PayerStatus",
  );

  // Initialise arrays
  $output = array();
  $resultArray = array();
  
  // Get the next token in the sequence
  for ($i = count($Tokens)-1; $i >= 0 ; $i--) {
    // Find the position in the string
    $start = strpos($thisString, $Tokens[$i]);
  // If it's present
    if ($start !== FALSE) {
      // Record position and token name
      $resultArray[$i]->start = $start;
      $resultArray[$i]->token = $Tokens[$i];
    }
  }
  
  // Sort in order of position
  sort($resultArray);
  // Go through the result array, getting the token values
  for ($i = 0; $i<count($resultArray); $i++) {
    // Get the start point of the value
    $valueStart = $resultArray[$i]->start + strlen($resultArray[$i]->token) + 1;
  // Get the length of the value
    if ($i==(count($resultArray)-1)) {
      $output[$resultArray[$i]->token] = substr($thisString, $valueStart);
    }
    else {
      $valueLength = $resultArray[$i+1]->start - $resultArray[$i]->start - strlen($resultArray[$i]->token) - 2;
    $output[$resultArray[$i]->token] = substr($thisString, $valueStart, $valueLength);
    }      

  }

  // Return the ouput array
  return $output;
}

/**
 * Filters unwanted characters out of an input string.  Useful for tidying up FORM field inputs.
 */
function _sagepayapi_cleanInput($strRawText, $strType) {

  if ($strType=="Number") {
    $strClean="0123456789.";
    $bolHighOrder=FALSE;
  }
  elseif ($strType=="VendorTxCode") {
    $strClean="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_.";
    $bolHighOrder=FALSE;
  }
  else {
      $strClean=" ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,'/{}@():?-_&£$=%~<>*+\"";
    $bolHighOrder=TRUE;
  }
  
  $strCleanedText="";
  $iCharPos = 0;
    
  do {
        // Only include valid characters
      $chrThisChar=substr($strRawText, $iCharPos, 1);
      
      if (strspn($chrThisChar, $strClean, 0, strlen($strClean))>0) { 
        $strCleanedText=$strCleanedText . $chrThisChar;
      }
      elseif ($bolHighOrder==TRUE) {
        // Fix to allow accented characters and most high order bit chars which are harmless 
        if (bin2hex($chrThisChar)>=191) {
          $strCleanedText=$strCleanedText . $chrThisChar;
        }
      }
      
    $iCharPos=$iCharPos+1;
    }
  while ($iCharPos<strlen($strRawText));
    
    $cleanInput = ltrim($strCleanedText);
  return $cleanInput;
  
}

/* Base 64 Encoding function **
** PHP does it natively but just for consistency and ease of maintenance, let's declare our own function **/

function _sagepayapi_base64_encode($plain) {
  // Initialise output variable
  $output = "";
  
  // Do encoding
  $output = base64_encode($plain);
  
  // Return the result
  return $output;
}

/* Base 64 decoding function **
** PHP does it natively but just for consistency and ease of maintenance, let's declare our own function **/

function _sagepayapi_base64_decode($scrambled) {
  // Initialise output variable
  $output = "";
  
  // Fix plus to space conversion issue
  $scrambled = str_replace(" ", "+", $scrambled);
  
  // Do encoding
  $output = base64_decode($scrambled);
  
  // Return the result
  return $output;
}


/*  The SimpleXor encryption algorithm                                                                                **
**  NOTE: This is a placeholder really.  Future releases of Form will use AES or TwoFish.  Proper encryption      **
**  This simple function and the Base64 will deter script kiddies and prevent the "View Source" type tampering        **
**  It won't stop a half decent hacker though, but the most they could do is change the amount field to something     **
**  else, so provided the vendor checks the reports and compares amounts, there is no harm done.  It's still          **
**  more secure than the other PSPs who don't both encrypting their forms at all                                      */

function _sagepayapi_simpleXor($InString, $Key) {
  // Initialise key array
  $KeyList = array();
  // Initialise out variable
  $output = "";
  
  // Convert $Key into array of ASCII values
  for ($i = 0; $i < strlen($Key); $i++) {
    $KeyList[$i] = ord(substr($Key, $i, 1));
  }

  // Step through string a character at a time
  for ($i = 0; $i < strlen($InString); $i++) {
    // Get ASCII code from string, get ASCII code from key (loop through with MOD), XOR the two, get the character from the result
    // % is MOD (modulus), ^ is XOR
    $output .= chr(ord(substr($InString, $i, 1)) ^ ($KeyList[$i % strlen($Key)]));
  }

  // Return the result
  return $output;
}

/**
 * Advertises the Sage Pay Protocol version this module implements
 */
function sagepayapi_protocol_version() {
  return "2.23";
}

/**
 * Builds array of countries
 */
function _sagepayapi_get_countries() {
  $countries = array(
    'US' => 'United States',
    'GB' => 'Great Britian',
    'AU' => 'Australia',
    'NZ' => 'New Zealand',
    'ZA' => 'South Africa',
  );
  return $countries;
}

/**
 * Builds array of states
 */
function _sagepayapi_get_states() {
  $states = array(
    'NULL' => '----',
    'AL' => 'Alabama',
    'AK' => 'Alaska',
    'AZ' => 'Arizona',
    'AR' => 'Arkansas',
    'CA' => 'California',
    'CO' => 'Colorado',
    'CT' => 'Connecticut',
    'DE' => 'Delaware',
    'DC' => 'District Of Columbia',
    'FL' => 'Florida',
    'GA' => 'Georgia',
    'HI' => 'Hawaii',
    'ID' => 'Idaho',
    'IL' => 'Illinois',
    'IN' => 'Indiana',
    'IA' => 'Iowa',
    'KS' => 'Kansas',
    'KY' => 'Kentucky',
    'LA' => 'Louisiana',
    'ME' => 'Maine',
    'MD' => 'Maryland',
    'MA' => 'Massachusetts',
    'MI' => 'Michigan',
    'MN' => 'Minnesota',
    'MS' => 'Mississippi',
    'MO' => 'Missouri',
    'MT' => 'Montana',
    'NE' => 'Nebraska',
    'NV' => 'Nevada',
    'NH' => 'New Hampshire',
    'NJ' => 'New Jersey',
    'NM' => 'New Mexico',
    'NY' => 'New York',
    'NC' => 'North Carolina',
    'ND' => 'North Dakota',
    'OH' => 'Ohio',
    'OK' => 'Oklahoma',
    'OR' => 'Oregon',
    'PA' => 'Pennsylvania',
    'RI' => 'Rhode Island',
    'SC' => 'South Carolina',
    'SD' => 'South Dakota',
    'TN' => 'Tennessee',
    'TX' => 'Texas',
    'UT' => 'Utah',
    'VT' => 'Vermont',
    'VA' => 'Virginia',
    'WA' => 'Washington',
    'WV' => 'West Virginia',
    'WI' => 'Wisconsin',
    'WY' => 'Wyoming',
  );
  return $states;
}

/**
 * Returns ISO 4217 Currency information
 */
function _sagepayapi_get_iso4217($cur = NULL) {
  $array = array(
    // There is a new sign as of January 2003. It does not yet have a Unicode
    // encoding yet (see http://std.dkuug.dk/jtc1/sc2/wg2/docs/n2640.pdf).
    'AFA' => array('name' => t('Afghanistani Afghani (AFA)'), 'symbol' => t('afghani'), 'decimals' => 2),
    'ALL' => array('name' => t('Albanian Lek (ALL)'), 'symbol' => t('Lek'), 'decimals' => 2),
    'DZD' => array('name' => t('Algerian Dinar (DZD)'), 'symbol' => t('Ø¯Ø¬'), 'decimals' => 2),
    'ARS' => array('name' => t('Argentine Peso (ARS)'), 'symbol' => t('$'), 'decimals' => 2),
    'AWG' => array('name' => t('Aruba Florin (AWG)'), 'symbol' => t('Æ’'), 'decimals' => 2),
    'AUD' => array('name' => t('Australian Dollar (AUD)'), 'symbol' => t('$'), 'decimals' => 2),
    'AZN' => array('name' => t('Azerbaijan New Maneat (AZN)'), 'symbol' => t('Ð¼Ð°Ð½'), 'decimals' => 2),
    'BSD' => array('name' => t('Bahamian Dollar (BSD)'), 'symbol' => t('D'), 'decimals' => 2),
    'BHD' => array('name' => t('Bahraini Dinar (BHD)'), 'symbol' => t('.Ø¯.Ø¨'), 'decimals' => 2),
    'BDT' => array('name' => t('Bangladeshi Taka (BDT)'), 'symbol' => t('à§³, à§²'), 'decimals' => 2),
    'BBD' => array('name' => t('Barbadian Dollar (BBD)'), 'symbol' => t('Bds$'), 'decimals' => 2),
    'BYR' => array('name' => t('Belarus Ruble (BYR)'), 'symbol' => t('p.'), 'decimals' => 2),
    'BZD' => array('name' => t('Belize Dollar (BZD)'), 'symbol' => t('BZ$'), 'decimals' => 2),
    'BMD' => array('name' => t('Bermuda Dollar (BMD)'), 'symbol' => t('$'), 'decimals' => 2),
    'BTN' => array('name' => t('Bhutanese Ngultrum (BTN)'), 'symbol' => t('Nu.'), 'decimals' => 2),
    'BOB' => array('name' => t('Bolivian Boliviano (BOB)'), 'symbol' => t('$b'), 'decimals' => 2),
    'BAM' => array('name' => t('Bosnia and Herzegovina Convertible Marka (BAM)'), 'symbol' => t('KM'), 'decimals' => 2),
    'BWP' => array('name' => t('Botswana Pula (BWP)'), 'symbol' => t('P'), 'decimals' => 2),
    'BRL' => array('name' => t('Brazilian Real (BRL)'), 'symbol' => t('R$'), 'decimals' => 2),
    'GBP' => array('name' => t('British Pound (GBP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    'BND' => array('name' => t('Brunei Dollar (BND)'), 'symbol' => t('$'), 'decimals' => 2),
    'BGN' => array('name' => t('Bulgarian Lev (BGN)'), 'symbol' => t('Ð»Ð²'), 'decimals' => 2),
    'BIF' => array('name' => t('Burundi Franc (BIF)'), 'symbol' => t('FBu'), 'decimals' => 2),
    'KHR' => array('name' => t('Cambodia Riel (KHR)'), 'symbol' => t('áŸ›'), 'decimals' => 2),
    'CAD' => array('name' => t('Canadian Dollar (CAD)'), 'symbol' => t('$'), 'decimals' => 2),
    'CVE' => array('name' => t('Cape Verdean Escudo (CVE)'), 'symbol' => t('Esc'), 'decimals' => 2),
    'KYD' => array('name' => t('Cayman Islands Dollar (KYD)'), 'symbol' => t('$'), 'decimals' => 2),
    'XOF' => array('name' => t('CFA Franc (BCEAO) (XOF)'), 'symbol' => t('F'), 'decimals' => 2),
    'XAF' => array('name' => t('CFA Franc (BEAC) (XAF)'), 'symbol' => t('F'), 'decimals' => 2),
    'CLP' => array('name' => t('Chilean Peso (CLP)'), 'symbol' => t('$'), 'decimals' => 2),
    'CNY' => array('name' => t('Chinese Yuan (CNY)'), 'symbol' => t('å…ƒ'), 'decimals' => 2),
    'COP' => array('name' => t('Colombian Peso (COP)'), 'symbol' => t('$'), 'decimals' => 2),
    'KMF' => array('name' => t('Comoros Franc (KMF)'), 'symbol' => t('F'), 'decimals' => 2),
    'CRC' => array('name' => t('Costa Rica Colon (CRC)'), 'symbol' => t('â‚¡'), 'decimals' => 2),
    'HRK' => array('name' => t('Croatian Kuna (HRK)'), 'symbol' => t('kn'), 'decimals' => 2),
    'CUP' => array('name' => t('Cuban Peso (CUP)'), 'symbol' => t('â‚±'), 'decimals' => 2),
    'CYP' => array('name' => t('Cyprus Pound (CYP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    'CZK' => array('name' => t('Czech Koruna (CZK)'), 'symbol' => t('KÄ'), 'decimals' => 2),
    'DKK' => array('name' => t('Danish Krone (DKK)'), 'symbol' => t('kr'), 'decimals' => 2),
    'DJF' => array('name' => t('Dijiboutian Franc (DJF)'), 'symbol' => t('Fdj'), 'decimals' => 2),
    'DOP' => array('name' => t('Dominican Peso (DOP)'), 'symbol' => t('RD$'), 'decimals' => 2),
    'XCD' => array('name' => t('East Caribbean Dollar (XCD)'), 'symbol' => t('$'), 'decimals' => 2),
    'EGP' => array('name' => t('Egyptian Pound (EGP)'), 'symbol' => t('LE'), 'decimals' => 2),
    'SVC' => array('name' => t('El Salvador Colon (SVC)'), 'symbol' => t('$'), 'decimals' => 2),
    'ERN' => array('name' => t('Eritrean Nakfa (ERN)'), 'symbol' => t('Nfk'), 'decimals' => 2),
    'EEK' => array('name' => t('Estonian Kroon (EEK)'), 'symbol' => t('kr'), 'decimals' => 2),
    'ETB' => array('name' => t('Ethiopian Birr (ETB)'), 'symbol' => t('Br'), 'decimals' => 2),
    'EUR' => array('name' => t('Euro (EUR)'), 'symbol' => t('â‚¬'), 'decimals' => 2),
    'FKP' => array('name' => t('Falkland Islands Pound (FKP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    'FJD' => array('name' => t('Fiji Dollar (FJD)'), 'symbol' => t('$'), 'decimals' => 2),
    'GMD' => array('name' => t('Gambian Dalasi (GMD)'), 'symbol' => t('D'), 'decimals' => 2),
    'GHC' => array('name' => t('Ghanian Cedi (GHC)'), 'symbol' => t('Â¢'), 'decimals' => 2),
    'GIP' => array('name' => t('Gibraltar Pound (GIP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    'XAU' => array('name' => t('Gold Ounces (XAU)'), 'symbol' => t('XAU'), 'decimals' => 2),
    'GTQ' => array('name' => t('Guatemala Quetzal (GTQ)'), 'symbol' => t('Q'), 'decimals' => 2),
    'GGP' => array('name' => t('Guernsey Pound (GGP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    'GNF' => array('name' => t('Guinea Franc (GNF)'), 'symbol' => t('FG'), 'decimals' => 2),
    'GYD' => array('name' => t('Guyana Dollar (GYD)'), 'symbol' => t('$'), 'decimals' => 2),
    'HTG' => array('name' => t('Haiti Gourde (HTG)'), 'symbol' => t('G'), 'decimals' => 2),
    'HNL' => array('name' => t('Honduras Lempira (HNL)'), 'symbol' => t('L'), 'decimals' => 2),
    'HKD' => array('name' => t('Hong Kong Dollar (HKD)'), 'symbol' => t('HK$'), 'decimals' => 2),
    'HUF' => array('name' => t('Hungarian Forint (HUF)'), 'symbol' => t('Ft'), 'decimals' => 2),
    'ISK' => array('name' => t('Iceland Krona (ISK)'), 'symbol' => t('kr'), 'decimals' => 2),
    'INR' => array('name' => t('Indian Rupee (INR)'), 'symbol' => t('â‚¨'), 'decimals' => 2),
    'IDR' => array('name' => t('Indonesian Rupiah (IDR)'), 'symbol' => t('Rp'), 'decimals' => 2),
    'IRR' => array('name' => t('Iran Rial (IRR)'), 'symbol' => t('ï·¼'), 'decimals' => 2),
    'IQD' => array('name' => t('Iraqi Dinar (IQD)'), 'symbol' => t('Ø¹.Ø¯'), 'decimals' => 2),
    'ILS' => array('name' => t('Israeli Shekel (ILS)'), 'symbol' => t('â‚ª'), 'decimals' => 2),
    'JMD' => array('name' => t('Jamaican Dollar (JMD)'), 'symbol' => t('J$'), 'decimals' => 2),
    'JPY' => array('name' => t('Japanese Yen (JPY)'), 'symbol' => t('Â¥'), 'decimals' => 0),
    'JOD' => array('name' => t('Jordanian Dinar (JOD)'), 'symbol' => t('din.'), 'decimals' => 2),
    'KZT' => array('name' => t('Kazakhstan Tenge (KZT)'), 'symbol' => t('Ð»Ð²'), 'decimals' => 2),
    'KES' => array('name' => t('Kenyan Shilling (KES)'), 'symbol' => t('KSh'), 'decimals' => 2),
    'KRW' => array('name' => t('Korean Won (KRW)'), 'symbol' => t('â‚©'), 'decimals' => 2),
    'KWD' => array('name' => t('Kuwaiti Dinar (KWD)'), 'symbol' => t('Ø¯.Ùƒ'), 'decimals' => 2),
    'KGS' => array('name' => t('Kyrgyzstan Som (KGS)'), 'symbol' => t('Ð»Ð²'), 'decimals' => 2),
    'LAK' => array('name' => t('Lao Kip (LAK)'), 'symbol' => t('â‚­'), 'decimals' => 2),
    'LVL' => array('name' => t('Latvian Lat (LVL)'), 'symbol' => t('Ls'), 'decimals' => 2),
    'LBP' => array('name' => t('Lebanese Pound (LBP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    // L for singular, M for plural
    'LSL' => array('name' => t('Lesotho Loti (LSL)'), 'symbol' => t('M'), 'decimals' => 2),
    'LRD' => array('name' => t('Liberian Dollar (LRD)'), 'symbol' => t('$'), 'decimals' => 2),
    'LYD' => array('name' => t('Libyan Dinar (LYD)'), 'symbol' => t('Ù„.Ø¯'), 'decimals' => 2),
    'LTL' => array('name' => t('Lithuanian Lita (LTL)'), 'symbol' => t('Lt'), 'decimals' => 2),
    'MOP' => array('name' => t('Macau Pataca (MOP)'), 'symbol' => t('MOP$'), 'decimals' => 2),
    'MKD' => array('name' => t('Macedonian Denar (MKD)'), 'symbol' => t('Ð´ÐµÐ½'), 'decimals' => 2),
    // Non-decimal currency.
    'MGA' => array('name' => t('iraimbilanja'), 'symbol' => t('iraimbilanja'), 'decimals' => 2),
    'MWK' => array('name' => t('Malawian Kwacha (MWK)'), 'symbol' => t('MK'), 'decimals' => 2),
    'MYR' => array('name' => t('Malaysian Ringgit (MYR)'), 'symbol' => t('RM'), 'decimals' => 2),
    'MVR' => array('name' => t('Maldives Rufiyaa (MVR)'), 'symbol' => t('Rf'), 'decimals' => 2),
    'MTL' => array('name' => t('Maltese Lira (MTL)'), 'symbol' => t('Lm'), 'decimals' => 2),
    // Non-decimal currency.
    'MRO' => array('name' => t('Mauritania Ougulya (MRO)'), 'symbol' => t('UM'), 'decimals' => 0),
    'MUR' => array('name' => t('Mauritius Rupee (MUR)'), 'symbol' => t('â‚¨'), 'decimals' => 2),
    'MXN' => array('name' => t('Mexican Peso (MXN)'), 'symbol' => t('$'), 'decimals' => 2),
    'MDL' => array('name' => t('Moldovan Leu (MDL)'), 'symbol' => t('lei'), 'decimals' => 2),
    'MNT' => array('name' => t('Mongolian Tugrik (MNT)'), 'symbol' => t('â‚®'), 'decimals' => 2),
    'MAD' => array('name' => t('Moroccan Dirham (MAD)'), 'symbol' => t('Ø¯.Ù….'), 'decimals' => 2),
    'MZM' => array('name' => t('Mozambique Metical (MZM)'), 'symbol' => t('MT'), 'decimals' => 2),
    'MMK' => array('name' => t('Myanmar Kyat (MMK)'), 'symbol' => t('K'), 'decimals' => 2),
    'NAD' => array('name' => t('Namibian Dollar (NAD)'), 'symbol' => t('$'), 'decimals' => 2),
    'NPR' => array('name' => t('Nepalese Rupee (NPR)'), 'symbol' => t('â‚¨'), 'decimals' => 2),
    'ANG' => array('name' => t('Neth Antilles Guilder (ANG)'), 'symbol' => t('Æ’'), 'decimals' => 2),
    'TRY' => array('name' => t('New Turkish Lira (TRY)'), 'symbol' => t('YTL'), 'decimals' => 2),
    'NZD' => array('name' => t('New Zealand Dollar (NZD)'), 'symbol' => t('$'), 'decimals' => 2),
    'NIO' => array('name' => t('Nicaragua Cordoba (NIO)'), 'symbol' => t('C$'), 'decimals' => 2),
    'NGN' => array('name' => t('Nigerian Naira (NGN)'), 'symbol' => t('â‚¦'), 'decimals' => 2),
    'KPW' => array('name' => t('North Korean Won (KPW)'), 'symbol' => t('â‚©'), 'decimals' => 2),
    'NOK' => array('name' => t('Norwegian Krone (NOK)'), 'symbol' => t('kr'), 'decimals' => 2),
    'OMR' => array('name' => t('Omani Rial (OMR)'), 'symbol' => t('ï·¼'), 'decimals' => 2),
    'XPF' => array('name' => t('Pacific Franc (XPF)'), 'symbol' => t('F'), 'decimals' => 2),
    'PKR' => array('name' => t('Pakistani Rupee (PKR)'), 'symbol' => t('â‚¨'), 'decimals' => 2),
    'XPD' => array('name' => t('Palladium Ounces (XPD)'), 'symbol' => t('XPD'), 'decimals' => 2),
    'PAB' => array('name' => t('Panama Balboa (PAB)'), 'symbol' => t('B/.'), 'decimals' => 2),
    'PGK' => array('name' => t('Papua New Guinea Kina (PGK)'), 'symbol' => t('K'), 'decimals' => 2),
    'PYG' => array('name' => t('Paraguayan Guarani (PYG)'), 'symbol' => t('Gs'), 'decimals' => 2),
    'PEN' => array('name' => t('Peruvian Nuevo Sol (PEN)'), 'symbol' => t('S/.'), 'decimals' => 2),
    'PHP' => array('name' => t('Philippine Peso (PHP)'), 'symbol' => t('Php'), 'decimals' => 2),
    'XPT' => array('name' => t('Platinum Ounces (XPT)'), 'symbol' => t('XPT'), 'decimals' => 2),
    'PLN' => array('name' => t('Polish Zloty (PLN)'), 'symbol' => t('zÅ‚'), 'decimals' => 2),
    'QAR' => array('name' => t('Qatar Rial (QAR)'), 'symbol' => t('ï·¼'), 'decimals' => 2),
    'RON' => array('name' => t('Romanian New Leu (RON)'), 'symbol' => t('lei'), 'decimals' => 2),
    'RUB' => array('name' => t('Russian Rouble (RUB)'), 'symbol' => t('Ñ€ÑƒÐ±.'), 'decimals' => 2),
    'RWF' => array('name' => t('Rwandese Franc (RWF)'), 'symbol' => t('RF'), 'decimals' => 2),
    'WST' => array('name' => t('Samoan Tala (WST)'), 'symbol' => t('WS$'), 'decimals' => 2),
    'STD' => array('name' => t('Sao Tome Dobra (STD)'), 'symbol' => t('Db'), 'decimals' => 2),
    'SAR' => array('name' => t('Saudi Arabian Riyal (SAR)'), 'symbol' => t('ï·¼'), 'decimals' => 2),
    'SCR' => array('name' => t('Seychelles Rupee (SCR)'), 'symbol' => t('â‚¨'), 'decimals' => 2),
    'RSD' => array('name' => t('Serbian Dinar (RSD)'), 'symbol' => t('Ð”Ð¸Ð½.'), 'decimals' => 2),
    'SLL' => array('name' => t('Sierra Leone Leone (SLL)'), 'symbol' => t('Le'), 'decimals' => 2),
    'XAG' => array('name' => t('Silver Ounces (XAG)'), 'symbol' => t('XAG'), 'decimals' => 2),
    'SGD' => array('name' => t('Singapore Dollar (SGD)'), 'symbol' => t('$'), 'decimals' => 2),
    'SKK' => array('name' => t('Slovak Koruna (SKK)'), 'symbol' => t('SIT'), 'decimals' => 2),
    'SBD' => array('name' => t('Solomon Islands Dollar (SBD)'), 'symbol' => t('$'), 'decimals' => 2),
    'SOS' => array('name' => t('Somali Shilling (SOS)'), 'symbol' => t('S'), 'decimals' => 2),
    'ZAR' => array('name' => t('South African Rand (ZAR)'), 'symbol' => t('R'), 'decimals' => 2),
    'LKR' => array('name' => t('Sri Lanka Rupee (LKR)'), 'symbol' => t('â‚¨'), 'decimals' => 2),
    'SHP' => array('name' => t('St Helena Pound (SHP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    'SDD' => array('name' => t('Sudanese Dinar (SDD)'), 'symbol' => t('Â£Sd'), 'decimals' => 2),
    'SRD' => array('name' => t('Surinam Dollar (SRD)'), 'symbol' => t('$'), 'decimals' => 2),
    // L for singular, E for plural
    'SZL' => array('name' => t('Swaziland Lilageni (SZL)'), 'symbol' => t('E'), 'decimals' => 2),
    'SEK' => array('name' => t('Swedish Krona (SEK)'), 'symbol' => t('kr'), 'decimals' => 2),
    'CHF' => array('name' => t('Swiss Franc (CHF)'), 'symbol' => t('CHF'), 'decimals' => 2),
    'SYP' => array('name' => t('Syrian Pound (SYP)'), 'symbol' => t('Â£'), 'decimals' => 2),
    'TWD' => array('name' => t('Taiwan Dollar (TWD)'), 'symbol' => t('NT$'), 'decimals' => 2),
    // No symbol, but instead an insane formatting.
    // See http://en.wikipedia.org/wiki/Tanzanian_shilling#Symbol.
    'TZS' => array('name' => t('Tanzanian Shilling (TZS)'), 'symbol' => t('TZS'), 'decimals' => 2),
    'THB' => array('name' => t('Thai Baht (THB)'), 'symbol' => t('à¸¿'), 'decimals' => 2),
    'TOP' => array('name' => t('Tonga Pa\'anga (TOP)'), 'symbol' => t('T$'), 'decimals' => 2),
    'TTD' => array('name' => t('Trinidad & Tobago Dollar (TTD)'), 'symbol' => t('TT$'), 'decimals' => 2),
    'TND' => array('name' => t('Tunisian Dinar (TND)'), 'symbol' => t('Ø¯.Øª'), 'decimals' => 2),
    'USD' => array('name' => t('U.S. Dollar (USD)'), 'symbol' => t('$'), 'decimals' => 2),
    'AED' => array('name' => t('UAE Dirham (AED)'), 'symbol' => t('Ø¯.Ø¥'), 'decimals' => 2),
    'UGX' => array('name' => t('Ugandan Shilling (UGX)'), 'symbol' => t('USh'), 'decimals' => 2),
    // There is a new sign as of March 2004, which is encoded as U+20B4 in
    // Unicode 4.1 released in 2005. It's not yet supported by most operating
    // systems, so I opted for the abbrevation instead.
    'UAH' => array('name' => t('Ukraine Hryvnia (UAH)'), 'symbol' => t('Ð³Ñ€Ð½.'), 'decimals' => 2),
    'UYU' => array('name' => t('Uruguayan New Peso (UYU)'), 'symbol' => t('$U'), 'decimals' => 2),
    'UZS' => array('name' => t('Uzbekistan Sum (UZS)'), 'symbol' => t('Ð»Ð²'), 'decimals' => 2),
    'VUV' => array('name' => t('Vanuatu Vatu (VUV)'), 'symbol' => t('Vt'), 'decimals' => 2),
    'VEB' => array('name' => t('Venezuelan Bolivar (VEB)'), 'symbol' => t('Bs'), 'decimals' => 2),
    'VND' => array('name' => t('Vietnam Dong (VND)'), 'symbol' => t('â‚«'), 'decimals' => 2),
    'YER' => array('name' => t('Yemen Riyal (YER)'), 'symbol' => t('ï·¼'), 'decimals' => 2),
    'YUM' => array('name' => t('Yugoslav Dinar (YUM)'), 'symbol' => t('Ð´Ð¸Ð½'), 'decimals' => 2),
    'ZMK' => array('name' => t('Zambian Kwacha (ZMK)'), 'symbol' => t('ZK'), 'decimals' => 2),
    'ZWD' => array('name' => t('Zimbabwe Dollar (ZWD)'), 'symbol' => t('Z$'), 'decimals' => 2),
  );
  if ($cur) {
    return $array($cur);
  }
  else {
    return $array;
  }
}

/**
 * Sends user to one of two different user-created pages depending upon status
 *
 * @param $status
 *   Boolean.  Either pass or fail.
 */
function sagepayapi_form_status_goto($status = 1) {
  if ($status) {
    $successurl = variable_get('sagepayapi_success_page', '');
    if ($successurl) {
      drupal_goto($successurl);
    }
  }
  else {
    $failurl = variable_get('sagepayapi_failure_page', '');
    if ($failurl) {
      drupal_goto($failurl);
    }
  }
}